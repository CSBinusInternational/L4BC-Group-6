<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="babylon.js"></script>
    <script src="hand-1.3.7.js"></script>
    <script src="babylonObjLoader.js"></script>
    <script src="Oimo.js"></script>
    <link rel="stylesheet" href="style.css">
    <title>Week 5 - Lab</title>
</head>
<body>
    <canvas id="myCanvas"></canvas>
    <script>

    	var alfa = 4.71238898038469;
        var canvas = document.getElementById("myCanvas");

        var engine = new BABYLON.Engine(canvas, true);
        var scene = new BABYLON.Scene(engine);

        scene.clearColor = new BABYLON.Color3(0.7, 0.3, 0.2);

        var camera = new BABYLON.ArcRotateCamera("cam1", 0, 0, 0, BABYLON.Vector3.Zero(), scene);
	    camera.setPosition(new BABYLON.Vector3(0,5,-10));
	    camera.attachControl(canvas, true);
	    // camera.angularSensibilityY = 1000000;

        var light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0,10,0), scene);
        var light1 = new BABYLON.HemisphericLight("light1", new BABYLON.Vector3(0,-10,0), scene);
        var light2 = new BABYLON.HemisphericLight("light1", new BABYLON.Vector3(10,5,0), scene);
        var light3 = new BABYLON.HemisphericLight("light1", new BABYLON.Vector3(-10,5,0), scene);
        light.intensity = 1;
        light1.intensity = 1;
        light2.intensity = 1;
        light3.intensity = 1;

        var ground = BABYLON.Mesh.CreateGround('ground1', 24,24,5, scene);
        var matGround = new BABYLON.StandardMaterial('ground1',scene);
        matGround.diffuseTexture = new BABYLON.Texture('Texture/grass.jpg', scene);
        ground.material = matGround;

        BABYLON.SceneLoader.ImportMesh("","", "kirito.babylon", scene, function (newMeshes, particleSystems, skeletons) {
            model = newMeshes[0];
	        globalSkele = skeletons[0];
	        model.position = new BABYLON.Vector3(0,0,0);
	        scene.beginAnimation(globalSkele, 0, 0, false, 1.0);
	        model.rotation.y = camera.alpha*-1 - alfa;
	        model.checkCollisions = true;
	        model.applyGravity = true;
        });

        ground.checkCollisions = true;

        scene.gravity = new BABYLON.Vector3(0, -0.9, 0);

        scene.collisionsEnabled = true;

        camera.checkCollisions = true;
        camera.applyGravity = true;
        camera.angularSensibility = 1000;
        camera.ellipsoid = new BABYLON.Vector3(1, 1, 1);


	    var animationState = false;
	    function startAnimation() {
	        if(!animationState){
	            animationState = true;
	            scene.beginAnimation(globalSkele, 1, 60, true, 1.0);
	        }
	    };

	    var keyCode = {};

        var model, globalSkele;
        
        window.onkeydown = function(event){
            event = event || window.event;
	        keyCode[event.keyCode || event.which ] = true;

            var degf = model.rotation.y * 180 / Math.PI;
	        var degl = degf + Math.PI/2 * 180;
	        var modelx, modelz;

	        //A
            if(keyCode[65]){
	            modelx = 0.05 * Math.sin(degf * Math.PI / 180) * -1;
	            modelz = 0.05 * Math.cos(degf * Math.PI / 180) * -1;
	            model.position = new BABYLON.Vector3(model.position.x+=modelx,0,model.position.z+=modelz);
	            startAnimation();
	        }
	        // W
	        if(keyCode[87]){
	            modelx = 0.05 * Math.sin(degf * Math.PI / 180) * -1;
	            modelz = 0.05 * Math.cos(degf * Math.PI / 180) * -1;
	            model.position = new BABYLON.Vector3(model.position.x+=modelx,0,model.position.z+=modelz);
	            startAnimation();
	        }
	        //S
	        if(keyCode[83]){
	            modelx = -0.05 * Math.sin(degf * Math.PI / 180) * -1;
	            modelz = -0.05 * Math.cos(degf * Math.PI / 180) * -1;
	            model.position = new BABYLON.Vector3(model.position.x+=modelx,0,model.position.z+=modelz);
	            startAnimation();
	        }
	        //D
	        if(keyCode[68]){
	            modelx = -0.05 * Math.sin(degf * Math.PI / 180) * -1;
	            modelz = -0.05 * Math.cos(degf * Math.PI / 180) * -1;
	            model.position = new BABYLON.Vector3(model.position.x+=modelx,0,model.position.z+=modelz);
	            startAnimation();
	        }

	        camera.setTarget(model);
    	}

        window.onkeyup = function(event){
            delete keyCode[event.keyCode];
            if(!keyCode[65]&&!keyCode[87]&&!keyCode[83]&&!keyCode[68]) {
                scene.stopAnimation(globalSkele);
                scene.beginAnimation(globalSkele, scene.currentFrame, 0, false, 1.0);
                animationState = false;
            }
        }

        ground.position.y = -1.2;

		var lastMove = 0;

        oldx = 0,
        oldy = 0,

        mousemovemethod = function (e) {

            if(Date.now() - lastMove > 40) {

                if (e.pageX < oldx) {
                    camera.rotation.y -= .1;
                } else if (e.pageX > oldx) {
                    camera.rotation.y += .1;
                }

                if (e.pageY < oldy) {
                    camera.rotation.x -= .1;
                } else if (e.pageY > oldy) {
                    camera.rotation.x += .1;
                }

                oldx = e.pageX;
                oldy = e.pageY;

                lastMove = Date.now();
            }
        }

        document.addEventListener('mousemove', mousemovemethod);
        
//        Create Scene End

        engine.runRenderLoop(function(){
        	if(camera.alpha!=alfa){
            model.rotation.y = camera.alpha*-1 - alfa;
        }
            scene.render();
        });

        window.addEventListener('resize', function(){
            engine.resize();
        });
    </script>
</body>
</html>