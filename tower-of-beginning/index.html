<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <script src="assets/js/babylon.js"></script>
    <script src="hand-1.3.7.js"></script>
    <script src="assets/js/babylonObjLoader.js"></script>
    <link rel="stylesheet" href="style.css">
    <script src="canvas2d.js"></script>
    <script src="cannon.js"></script>
    <title>Week 5 - Lab</title>
</head>
<body>
    <canvas id="myCanvas"></canvas>
    <script>
//============================================ Canvas & Camera =========================================================
        var canvas = document.getElementById("myCanvas");
        var engine = new BABYLON.Engine(canvas, true);
        var scene = new BABYLON.Scene(engine);

        var camera = new BABYLON.ArcRotateCamera("camera1", Math.PI/2,Math.PI/3,20, new BABYLON.Vector3(0,-70,0), scene);

        camera.attachControl(canvas, false);
//==================================== End of Canvas & Camera ==========================================================


//========================================== Start Menu ================================================================
        var mainMenu = function(scene){
            var size = document.getElementById("myCanvas");
            var canvas = new BABYLON.ScreenSpaceCanvas2D(scene,{
                id: "cameraCanvas",
                backgroundFill: "#00000000",
                size: new BABYLON.Size(size.clientWidth,size.clientHeight)
            });

            var textureM = new BABYLON.Texture("Images/linkS.jpg", scene);
            textureM.wrapU = BABYLON.Texture.CLAMP_ADDRESSMODE;
            textureM.wrapV = BABYLON.Texture.CLAMP_ADDRESSMODE;
            var spriteMenu = new BABYLON.Sprite2D(textureM, {
                parent: canvas,
                id: "sora",
                marginAlignment: "h: center, v: center",
                size: new BABYLON.Size(size.clientWidth,size.clientHeight),
                children:
                    [
                        new BABYLON.Text2D("Link Start!", { fontName: "40pt Arial", marginAlignment: "h: center, v: center" })
                    ]});

            spriteMenu.pointerEventObservable.add(function (d, s) {
                spriteMenu.levelVisible = !spriteMenu.levelVisible;
                var music = new BABYLON.Sound("Music", "sao.mp3",scene, null, {loop: false, autoplay: true, useCustomAttenuation: true});
            }, BABYLON.PrimitivePointerInfo.PointerUp);

            return canvas;
        };
//========================================= End of Start Menu ==========================================================

        scene.gravity = new BABYLON.Vector3(0, -9.81, 0);

        scene.collisionsEnabled = true;
        camera.checkCollisions = true;
        camera.applyGravity = true;
        camera.angularSensibility = 1000;
        camera.ellipsoid = new BABYLON.Vector3(1, 1, 1);

        scene.enablePhysics();

        var light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0,10,0), scene);

        light.intensity = 0.5;

            scene.fogMode = BABYLON.Scene.FOGMODE_EXP;
            scene.fogDensity = 0.01;
            scene.fogColor = new BABYLON.Color3(0.2,0.2,0.3);



        var playerposx;
        var playerposz;
        var model;
        var d;
        var flagD = false;
        var enemySpeed = 0.1;
        mainMenu(scene);
        //=============================== Creating Character ==========================================================
        BABYLON.SceneLoader.ImportMesh("","", "kirito.babylon", scene, function (newMeshes, particleSystems, skeletons) {
            model = newMeshes[0];
            globalSkele = skeletons[0];
            model.position = new BABYLON.Vector3(0, -70.65, 0);
//            model.checkCollisions = true;
//            model.applyGravity = true;
//            model.ellipsoid = new BABYLON.Vector3(0.5, 1.0, 0.5);
//            model.ellipsoidOffset = new BABYLON.Vector3(0, 1.0, 0);
//            model.rotation.y = camera.alpha * -1;
            model.scaling = new BABYLON.Vector3(5, 5, 5);

//            model.physicsImpostor = new BABYLON.PhysicsImpostor(model, BABYLON.PhysicsImpostor.BoxImpostor, { mass: 0, restitution: 0.9 }, scene);
//            model.physicsImpostor = new BABYLON.PhysicsImpostor(model, BABYLON.PhysicsImpostor.BoxImpostor, { mass: 0, restitution: 1000, friction: 1000000}, scene);

         //=============================================== Health Bar ==============================================
            var healthBarMaterial = new BABYLON.StandardMaterial("hb1mat", scene);
            healthBarMaterial.diffuseColor = BABYLON.Color3.Green();
            healthBarMaterial.backFaceCulling = false;

            var healthBarContainerMaterial = new BABYLON.StandardMaterial("hb2mat", scene);
            healthBarContainerMaterial.diffuseColor = BABYLON.Color3.Black();
            healthBarContainerMaterial.backFaceCulling = false;

            var dynamicTexture = new BABYLON.DynamicTexture("dt1", 512, scene, true);
            dynamicTexture.hasAlpha = true;

            var healthBarTextMaterial = new BABYLON.StandardMaterial("hb3mat", scene);
            healthBarTextMaterial.diffuseTexture = dynamicTexture;
            healthBarTextMaterial.backFaceCulling = false;
            healthBarTextMaterial.diffuseColor = BABYLON.Color3.Green();

            var hBar = BABYLON.Mesh.CreatePlane("hbar", 10, scene,false);
            hBar.billboardMode = BABYLON.AbstractMesh.BILLBOARDMODE_ALL;
            hBar.material = new BABYLON.StandardMaterial("hb",scene);
            hBar.position.y = 1.3;
            hBar.parent = model;

            var hBarTexture = new BABYLON.DynamicTexture("dyn",512,scene, true);
            hBar.material.diffuseTexture = hBarTexture;
            hBar.material.specularColor = new BABYLON.Color3(0,0,0);
            hBar.material.specularColor = new BABYLON.Color3(1,1,1);
            hBar.material.backFaceCulling = false;


            hBarTexture.drawText("Kirito", null, 300, "bold 24px timesnewroman", "white");
            hBarTexture.hasAlpha = true;


            var healthBar = BABYLON.MeshBuilder.CreatePlane("hb1", {width:2, height:.5, subdivisions:4}, scene);
            var healthBar1 = BABYLON.MeshBuilder.CreatePlane("hb4", {width:2, height:.5, subdivisions:4}, scene);
            var healthBarContainer = BABYLON.MeshBuilder.CreatePlane("hb2", { width: 2, height: .5, subdivisions: 4 }, scene);
            var healthBarText = BABYLON.MeshBuilder.CreatePlane("hb3", { width: 2, height: 2, subdivisions: 4 }, scene);
            healthBarText.material = healthBarMaterial;

            healthBarContainer.billboardMode = BABYLON.AbstractMesh.BILLBOARDMODE_ALL;


            healthBar.position = new BABYLON.Vector3(0, 0, -.01);           // Move in front of container slightly.  Without this there is flickering.
            healthBar1.position = new BABYLON.Vector3(0, 0, .01);
            healthBarContainer.position = new BABYLON.Vector3(0, 1, 0);     // Position above model.
            healthBarText.position = new BABYLON.Vector3(-1.5, -.4, 0);

            healthBar.parent = healthBarContainer;
            healthBar1.parent = healthBarContainer;
            healthBarContainer.parent = model;
            healthBarText.parent = healthBarContainer;

            healthBar.material = healthBarMaterial;
            healthBar1.material = healthBarMaterial;
            healthBarContainer.material = healthBarContainerMaterial;
            healthBarText.material = healthBarTextMaterial;


            var alive = true;
            var healthPercentage = 100;
            //===================================== End of Health Bar ==================================================


            //==================================== RegiesterBeforeRender ===============================================
            scene.registerBeforeRender(function () {

                //==================================== Checking Health =================================================
                if (alive) {

                    // Re-calculate healthbar length.
                    healthBar.scaling.x = healthPercentage / 100;
                    healthBar.position.x = (1 - (healthPercentage / 100)) * -1;
                    healthBar1.scaling.x = healthPercentage / 100;
                    healthBar1.position.x = (1 - (healthPercentage / 100)) * -1;

                    if (healthBar.scaling.x < 0) {
                        alive = false;
                    }
                    else if (healthBar.scaling.x <= .5) {
                        healthBarMaterial.diffuseColor = BABYLON.Color3.Yellow();
                        healthBarTextMaterial.diffuseColor = BABYLON.Color3.Yellow();
                        if (healthBar.scaling.x <= .3) {
                            healthBarMaterial.diffuseColor = BABYLON.Color3.Red();
                            healthBarTextMaterial.diffuseColor = BABYLON.Color3.Red();
                        }

                    }
                }

                    // Display Health Percentage.
                    // - Only update display if whole number.
                    if (alive == true) {
                        var textureContext = dynamicTexture.getContext();
                        var size = dynamicTexture.getSize();
                        var text = Math.round(healthPercentage) + "%  ";
                        textureContext.clearRect(0, 0, size.width, size.height);

                        textureContext.font = "bold 120px Calibri";
                        var textSize = textureContext.measureText(text);
                        textureContext.fillStyle = "white";
                        textureContext.fillText(text, (size.width - textSize.width) / 2, (size.height - 120) / 2);

                        dynamicTexture.update();
                    }
                    //============================== End of Checking Health ============================================



                    //============================== Enemy Damage ======================================================
//                    box.actionManager = new BABYLON.ActionManager(scene);
                    if (alive != false) {
//                    box.actionManager.registerAction(new BABYLON.ExecuteCodeAction(
//                        {trigger: BABYLON.ActionManager.OnIntersectionEnterTrigger, parameter: model}
//
//                        , function () {
//                                healthPercentage -= 5;
//
//                        }));
                        if (box.intersectsMesh(model, false)) {
                            healthPercentage -= 0.1;
                        }

                    }

                    //================================ End of Damage =======================================================
//                if (alive == false){
//                    window.setTimeout(function() {
//                        location.reload();
//                    }, 10000);
//                }
                    //=================================== Character Out of Arena ==============================================
                    d = Math.sqrt(model.position.x * model.position.x + model.position.z * model.position.z);
                    if (d > 150 || flagD) {
                        model.position.y -= 0.5;
                        flagD = true;
                        healthPercentage -= 0.5;
                    }
                    //=============================== End of Character Out of Arena ===========================================


                    //=============================== Enemy Chasing Character =================================================
         if(alive != false) {
             playerposx = model.position.x;
             playerposz = model.position.z;
             if (box.position.x > playerposx) box.position.x -= enemySpeed;
             else if (box.position.x < playerposx) box.position.x += enemySpeed;
             if (box.position.z > playerposz) box.position.z -= enemySpeed;
             else if (box.position.z < playerposz) box.position.z += enemySpeed;

         }
            //==================================== End of Enemy Chasing Character ======================================

            });
        //========================================= End of BeforeRunRender ==============================================

            //===================================== Create Enemy ===========================================================

            var box = BABYLON.MeshBuilder.CreateBox("box", {width: 3, height: 2, depth: 3}, scene);
            box.position = new BABYLON.Vector3(25, -70, 30);
            box.checkCollisions = true;


                var wolf;
                BABYLON.SceneLoader.ImportMesh("","", "wolf.babylon", scene, function (newMeshes, particleSystems, skeletons) {
                    wolf = newMeshes[0];
                    globalSkele = skeletons[0];
                    wolf.position = new BABYLON.Vector3(25,-70.85,30);
                    wolf.scaling = new BABYLON.Vector3(10,10,10);
                });


            //=================================== End of Enemy =============================================================





            //========================================= In Game Menu ===============================================================

            var gameMenu = function(scene){
                var size = document.getElementById("myCanvas");
                var canvas = new BABYLON.ScreenSpaceCanvas2D(scene,{
                    id: "cameraCanvas",
//                size: new BABYLON.Size(size.clientWidth,size.clientHeight)
                });
                var textureGM = new BABYLON.Texture("", scene);
                textureGM.wrapU = BABYLON.Texture.CLAMP_ADDRESSMODE;
                textureGM.wrapV = BABYLON.Texture.CLAMP_ADDRESSMODE;
                var spriteMenu = new BABYLON.Sprite2D(textureGM, {
                    parent: canvas,
                    id: "sora",
                    marginAlignment: "h: center, v: center",
                    isVisible: true,
                    y: 250, width: 200, height: 80,
                    children:
                        [
                            new BABYLON.Text2D("Select Number:", { fontName: "40pt Arial", marginAlignment: "h: center, v: center" })
                        ]});


                var button1Rect = new BABYLON.Rectangle2D(
                    { parent: canvas, id: "button1", width: 200, height: 80, fill: "#4040C0FF",marginAlignment: "h: left, v: center",
                        roundRadius: 10,
                        isVisible: true,
                        children:
                            [
                                new BABYLON.Text2D("Easy", { fontName: "30pt Arial", marginAlignment: "h: center, v: center" })
                            ]});

                var button2Rect = new BABYLON.Rectangle2D(
                    { parent: canvas, id: "button2", width: 200, height: 80, fill: "#4040C0FF",marginAlignment: "h: center, v: center",
                        roundRadius: 10,
                        isVisible: true,
                        children:
                            [
                                new BABYLON.Text2D("Medium", { fontName: "30pt Arial", marginAlignment: "h: center, v: center" })
                            ]});

                var button3Rect = new BABYLON.Rectangle2D(
                    { parent: canvas, id: "button3",  width: 200, height: 80, fill: "#4040C0FF", marginAlignment: "h: right, v: center",
                        roundRadius: 10,
                        isVisible: true,
                        children:
                            [
                                new BABYLON.Text2D("Hard", { fontName: "30pt Arial", marginAlignment: "h: center, v: center" })
                            ]});

                button1Rect.pointerEventObservable.add(function (d, s) {
                    spriteMenu.levelVisible = !spriteMenu.levelVisible;
                    button1Rect.levelVisible = !button1Rect.levelVisible;
                    button2Rect.levelVisible = !button2Rect.levelVisible;
                    button3Rect.levelVisible = !button3Rect.levelVisible;


                    //===================================== Create Enemy ===========================================================

//                    var box = BABYLON.MeshBuilder.CreateBox("box", {width: 3, height: 2, depth: 3}, scene);
//                    box.position = new BABYLON.Vector3(25, -70, 30);
//                    box.checkCollisions = true;

                    //=================================== End of Enemy =============================================================

                }, BABYLON.PrimitivePointerInfo.PointerUp);

                button2Rect.pointerEventObservable.add(function (d, s) {
                    spriteMenu.levelVisible = !spriteMenu.levelVisible;
                    button1Rect.levelVisible = !button1Rect.levelVisible;
                    button2Rect.levelVisible = !button2Rect.levelVisible;
                    button3Rect.levelVisible = !button3Rect.levelVisible;

                }, BABYLON.PrimitivePointerInfo.PointerUp);

                button3Rect.pointerEventObservable.add(function (d, s) {
                    spriteMenu.levelVisible = !spriteMenu.levelVisible;
                    button1Rect.levelVisible = !button1Rect.levelVisible;
                    button2Rect.levelVisible = !button2Rect.levelVisible;
                    button3Rect.levelVisible = !button3Rect.levelVisible;

                }, BABYLON.PrimitivePointerInfo.PointerUp);


                return canvas;
            };




//================================= End of In Game Menu ================================================================









         //===================================== Create MenuUI ========================================================

                    var Menu = BABYLON.MeshBuilder.CreateBox("menu", {width: 3, height: 2, depth: 3}, scene);
                    Menu.position = new BABYLON.Vector3(-25, -70, 30);
                    Menu.actionManager = new BABYLON.ActionManager(scene);

                    Menu.actionManager.registerAction(new BABYLON.ExecuteCodeAction(
                        {trigger: BABYLON.ActionManager.OnIntersectionEnterTrigger, parameter: model}

                        , function () {
                            gameMenu(scene);

                        }));




        //=================================== End of MenuUI =============================================================



        });

        //========================================== End of Character ==================================================










//================================================== Character Movements ===============================================
        var keyCode = {};
        window.onkeydown = function (event) {
            event = event || window.event;
            keyCode[event.which || event.keyCode] = event.type;
            var deg = model.rotation.y * 180 / Math.PI;


            var playerz = 0.5 * Math.cos(deg * Math.PI / 180) * -1;
            var playerx = 0.5 * Math.sin(deg * Math.PI / 180) * -1;
            model.rotation.y = (Math.PI / 2 - camera.alpha);
            if (keyCode[87] && keyCode[68]) {
                model.rotation.y = Math.PI / 4 + Math.PI / 2 - camera.alpha;
                model.position = new BABYLON.Vector3(model.position.x += playerx, model.position.y, model.position.z += playerz);
                camera.target = new BABYLON.Vector3(camera.target.x += playerx, camera.target.y, camera.target.z += playerz);
            }
            else if (keyCode[87] && keyCode[65]) {
                model.rotation.y = Math.PI / 4 - camera.alpha;
                model.position = new BABYLON.Vector3(model.position.x += playerx, model.position.y, model.position.z += playerz);
                camera.target = new BABYLON.Vector3(camera.target.x += playerx, camera.target.y, camera.target.z += playerz);
            }
            else if (keyCode[83] && keyCode[68]) {
                model.rotation.y = -Math.PI / 4 - Math.PI / 2 - camera.alpha;
                model.position = new BABYLON.Vector3(model.position.x += playerx, model.position.y, model.position.z += playerz);
                camera.target = new BABYLON.Vector3(camera.target.x += playerx, camera.target.y, camera.target.z += playerz);
            }
            else if (keyCode[83] && keyCode[65]) {
                model.rotation.y = Math.PI / 4 - Math.PI / 2 - camera.alpha;
                model.position = new BABYLON.Vector3(model.position.x += playerx, model.position.y, model.position.z += playerz);
                camera.target = new BABYLON.Vector3(camera.target.x += playerx, camera.target.y, camera.target.z += playerz);
            }
            else if (keyCode[87]) {
                //W
                model.rotation.y = Math.PI / 2 - camera.alpha;
                model.position = new BABYLON.Vector3(model.position.x += playerx, model.position.y, model.position.z += playerz);
                camera.target = new BABYLON.Vector3(camera.target.x += playerx, camera.target.y, camera.target.z += playerz);
            }
            else if (keyCode[83]) {
                //S
                model.rotation.y = Math.PI + (Math.PI / 2 - camera.alpha);
                model.position = new BABYLON.Vector3(model.position.x += playerx, model.position.y, model.position.z += playerz);
                camera.target = new BABYLON.Vector3(camera.target.x += playerx, camera.target.y, camera.target.z += playerz);
            }
            else if (keyCode[68]) {
                //D
                model.rotation.y = Math.PI / 2 + (Math.PI / 2 - camera.alpha);
                model.position = new BABYLON.Vector3(model.position.x += playerx, model.position.y, model.position.z += playerz);
                camera.target = new BABYLON.Vector3(camera.target.x += playerx, camera.target.y, camera.target.z += playerz);
            }
            else if (keyCode[65]) {
                //A
                model.rotation.y = Math.PI * 3 / 2 + (Math.PI / 2 - camera.alpha);
                model.position = new BABYLON.Vector3(model.position.x += playerx, model.position.y, model.position.z += playerz);
                camera.target = new BABYLON.Vector3(camera.target.x += playerx, camera.target.y, camera.target.z += playerz);
            }
        };

            window.onkeyup = function (event) {
                delete keyCode[event.keyCode];
            };


        //=================================== Sky Box =================================================================
         var skybox = BABYLON.MeshBuilder.CreateBox("skyBox", {size:500.0}, scene);
         var skyboxMaterial = new BABYLON.StandardMaterial("skyBox", scene);
         skyboxMaterial.backFaceCulling = false;
         skyboxMaterial.reflectionTexture = new BABYLON.CubeTexture("textures/skybox", scene);
         skyboxMaterial.reflectionTexture.coordinatesMode = BABYLON.Texture.SKYBOX_MODE;
         skyboxMaterial.diffuseColor = new BABYLON.Color3(0, 0, 0);
         skyboxMaterial.specularColor = new BABYLON.Color3(0, 0, 0);
         skybox.material = skyboxMaterial;
         //================================  End of Sky Box ===========================================================

        var mat = new BABYLON.StandardMaterial("mat1", scene);
        mat.alpha = 1.0;
        mat.diffuseColor = new BABYLON.Color3(1, 1, 1);
        mat.backFaceCulling = false;

        var texture = new BABYLON.Texture("Images/floor.jpg", scene);
        mat.diffuseTexture = texture;


        var cylinder = BABYLON.MeshBuilder.CreateCylinder("ground1", {diameterTop : 300, diameterBottom: 80, tessellation: 48, height: 50 }, scene);

        cylinder.material = mat;
         cylinder.position = new BABYLON.Vector3(0, -100, 0);
         cylinder.material.diffuseColor = new BABYLON.Color3(1,0,0);

         var cylinder2 = BABYLON.MeshBuilder.CreateCylinder("ground2", {diameter: 80, tessellation: 48, height: 100 }, scene);
         var matGround1 = new BABYLON.StandardMaterial('ground2',scene);

         // matGround.diffuseTexture = new BABYLON.TextureandardMaterial('ground1',scene);('Texture/grass.jpg', scene);
         cylinder2.material = matGround1;
         cylinder2.position = new BABYLON.Vector3(0, -150, 0);
         cylinder2.material.diffuseColor = new BABYLON.Color3(1,1,1);

        cylinder.checkCollisions = true;


        engine.runRenderLoop(function(){

            if (camera.radius > 70)    camera.radius = 70;
            if (camera.radius < 20)    camera.radius = 20;
//            camera.beta = Math.PI/4;

//            console.log(camera.alpha);


            scene.render();
        });

        window.addEventListener('resize', function(){
            engine.resize();
        });

    </script>
</body>
</html>